<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-content="wallet.title">Carteira - Swift Elite Rewards</title>
    <meta name="description" data-content="wallet.description" content="Gerencie sua carteira Swift Elite e acompanhe suas transações">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Custom CSS -->
    <link href="css/styles.css" rel="stylesheet">
</head>
<body>
  <div class="d-flex min-vh-100">
    <!-- Sidebar Desktop -->
    <nav class="sidebar d-none d-lg-block bg-white border-end shadow-sm">
      <div class="d-flex flex-column h-100 p-4 pe-3">
        <div class="d-flex align-items-center mb-4">
          <div class="icon-circle-small me-3">
            <i data-lucide="zap" class="text-brand"></i>
          </div>
          <h6 class="mb-0 fw-bold text-brand" data-content="app.brand"></h6>
        </div>
        
        <!-- Bloco de Perfil Minimalista -->
        <div class="profile-minimal mb-4 text-center">
          <div class="mb-2">
            <img src="images/colaborador.png" alt="Foto do colaborador" class="rounded-circle" style="width: 70px; height: 70px; object-fit: cover; border: 2px solid var(--brand-color);">
          </div>
          <h6 class="mb-0 fw-bold text-brand" data-content="user.name"></h6>
        </div>
        
        <ul class="nav flex-column gap-1">
          <li class="nav-item">
            <a class="nav-link d-flex align-items-center px-3 py-2 rounded-2" href="inicio.html">
              <i data-lucide="home" class="me-3" style="width: 20px; height: 20px;"></i>
              <span data-content="nav.home"></span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link d-flex align-items-center px-3 py-2 rounded-2" href="dashboard.html">
              <i data-lucide="user" class="me-3" style="width: 20px; height: 20px;"></i>
              <span data-content="nav.collaborator"></span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active d-flex align-items-center px-3 py-2 rounded-2 bg-brand text-white" href="carteira.html">
              <i data-lucide="wallet" class="me-3" style="width: 20px; height: 20px;"></i>
              <span data-content="nav.wallet"></span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link d-flex align-items-center px-3 py-2 rounded-2" href="#rewards">
              <i data-lucide="gift" class="me-3" style="width: 20px; height: 20px;"></i>
              <span data-content="nav.rewards"></span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link d-flex align-items-center px-3 py-2 rounded-2" href="#ranking">
              <i data-lucide="trophy" class="me-3" style="width: 20px; height: 20px;"></i>
              <span data-content="nav.ranking"></span>
            </a>
          </li>
        </ul>

        <!-- Bottom Navigation -->
        <div class="mt-auto border-top pt-3">
          <ul class="nav flex-column gap-1">
            <li class="nav-item">
              <a class="nav-link d-flex align-items-center px-3 py-2 rounded-2" href="#settings">
                <i data-lucide="settings" class="me-3" style="width: 20px; height: 20px;"></i>
                <span data-content="nav.settings"></span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link d-flex align-items-center px-3 py-2 rounded-2 text-danger" href="index.html">
                <i data-lucide="log-out" class="me-3" style="width: 20px; height: 20px;"></i>
                <span data-content="nav.logout"></span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Conteúdo Principal -->
    <main class="flex-grow-1">
      <!-- Header Sticky -->
      <header class="sticky-top bg-white border-bottom shadow-sm">
        <div class="container-fluid py-3 px-4">
          <div class="row align-items-center">
            <div class="col-auto d-lg-none">
              <!-- Botão Mobile Menu -->
              <button class="btn btn-outline-secondary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar" aria-controls="offcanvasSidebar">
                <i data-lucide="menu" style="width: 20px; height: 20px;"></i>
              </button>
            </div>
            
            <div class="col">
              <h1 class="h4 mb-0 fw-bold text-dark" data-content="wallet.header.title">Minha Carteira</h1>
            </div>
          </div>
        </div>
      </header>

      <!-- Container Principal -->
      <div class="container-fluid px-4 py-4">

        <!-- Header Saldo Total em Benefícios -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card border-0 shadow-sm rounded-3">
              <div class="card-body p-4">
                <!-- Título e Subtítulo -->
                <h3 class="h5 mb-2 fw-bold text-dark" data-content="wallet.total_benefits.title">Saldo total em benefícios</h3>

                <!-- Valor Principal -->
                <div class="d-flex align-items-baseline gap-3 mb-2">
                  <h1 class="fs-2 fw-bold text-brand mb-0 lh-11 balance-blur" id="wallet-balance-value" data-content="wallet.total_benefits.value" aria-live="polite">1.250</h1>
                  <button id="btn-toggle-visibility" class="btn btn-sm px-2 py-1" style="border: none; background: none; min-width: 32px; min-height: 32px; display: flex; align-items: center; justify-content: center;" aria-label="Mostrar saldo" aria-pressed="false">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--text-muted); opacity: 0.7;"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                  </button>
                  <span class="badge bg-light text-muted ms-2">Disponível</span>
                </div>

                <!-- CTAs -->
                <div id="wallet-cta-container" class="d-flex gap-2">
                  <button class="btn btn-primary btn-sm" onclick="window.SwiftEliteRewards?.redeem?.()">
                    <i data-lucide="gift" class="me-1" style="width: 14px; height: 14px;"></i>
                    Resgatar
                  </button>
                  <button class="btn btn-link btn-sm text-muted p-0" onclick="window.SwiftEliteRewards?.viewMissions?.()">
                    Ver missões
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Seção Transações Recentes -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h2 class="h5 mb-0 fw-bold text-dark" data-content="transactions.title">Transações Recentes</h2>
              <button class="btn btn-outline-secondary btn-sm" onclick="expandTransactions()" title="Ver todas as transações">
                <i data-lucide="chevron-down" style="width: 16px; height: 16px;"></i>
                <span class="ms-1">Ver mais</span>
              </button>
            </div>
            <div class="table-responsive">
              <table class="table table-borderless mb-0">
                <thead>
                  <tr>
                    <th class="px-4 py-3 text-muted small fw-semibold" data-content="transactions.th.date">Data</th>
                    <th class="px-4 py-3 text-muted small fw-semibold" data-content="transactions.th.time">Hora</th>
                    <th class="px-4 py-3 text-muted small fw-semibold" data-content="transactions.th.desc">Descrição</th>
                    <th class="px-4 py-3 text-muted small fw-semibold" data-content="transactions.th.amount">Valor</th>
                    <th class="px-4 py-3 text-muted small fw-semibold" data-content="transactions.th.type">Tipo</th>
                    <th class="px-4 py-3 text-muted small fw-semibold" data-content="transactions.th.category">Categoria</th>
                  </tr>
                </thead>
                <tbody id="txTableBody">
                  <!-- Preenchido via JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- O que você ainda pode ganhar -->
        <div class="row mb-4 mt-5">
          <div class="col-12">
            <h2 class="h5 mb-4 fw-bold text-dark" data-content="rewards.moreTitle">O que você ainda pode ganhar?</h2>
            <div class="row g-3" id="rewardsGrid">
              <!-- Cards gerados dinamicamente -->
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Offcanvas Mobile -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasSidebar" aria-labelledby="offcanvasSidebarLabel">
    <div class="offcanvas-header border-bottom">
      <div class="d-flex align-items-center">
        <div class="icon-circle-small me-3">
          <i data-lucide="zap" class="text-brand"></i>
        </div>
        <h5 class="offcanvas-title fw-bold text-brand" id="offcanvasSidebarLabel" data-content="app.brand">Swift Elite</h5>
      </div>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-aria-label="nav.close" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <!-- Bloco de Perfil Mobile Minimalista -->
      <div class="profile-minimal mb-4 text-center">
        <div class="mb-2">
          <img src="images/colaborador.png" alt="Foto do colaborador João Silva" class="rounded-circle" style="width: 56px; height: 56px; object-fit: cover; border: 2px solid var(--brand-color);">
        </div>
        <h6 class="mb-0 fw-bold text-brand" data-content="user.name">João Silva</h6>
      </div>
      <ul class="nav flex-column gap-1">
        <li class="nav-item">
          <a class="nav-link d-flex align-items-center px-3 py-2 rounded-2" href="inicio.html">
            <i data-lucide="home" class="me-3" style="width: 20px; height: 20px;"></i>
            <span data-content="nav.home">Início</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link d-flex align-items-center px-3 py-2 rounded-2" href="dashboard.html">
            <i data-lucide="user" class="me-3" style="width: 20px; height: 20px;"></i>
            <span data-content="nav.collaborator">Colaborador</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active d-flex align-items-center px-3 py-2 rounded-2 bg-brand text-white" href="carteira.html">
            <i data-lucide="wallet" class="me-3" style="width: 20px; height: 20px;"></i>
            <span data-content="nav.wallet">Carteira</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link d-flex align-items-center px-3 py-2 rounded-2" href="#rewards">
            <i data-lucide="gift" class="me-3" style="width: 20px; height: 20px;"></i>
            <span data-content="nav.rewards">Recompensas</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link d-flex align-items-center px-3 py-2 rounded-2" href="#ranking">
            <i data-lucide="trophy" class="me-3" style="width: 20px; height: 20px;"></i>
            <span data-content="nav.ranking">Ranking</span>
          </a>
        </li>
      </ul>

      <!-- Bottom Navigation -->
      <div class="mt-auto border-top pt-3">
        <ul class="nav flex-column gap-1">
          <li class="nav-item">
            <a class="nav-link d-flex align-items-center px-3 py-2 rounded-2" href="#settings">
              <i data-lucide="settings" class="me-3" style="width: 20px; height: 20px;"></i>
              <span data-content="nav.settings">Configurações</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link d-flex align-items-center px-3 py-2 rounded-2 text-danger" href="index.html">
              <i data-lucide="log-out" class="me-3" style="width: 20px; height: 20px;"></i>
              <span data-content="nav.logout">Sair</span>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Alert Container -->
  <div id="alertContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>

  <!-- Bootstrap 5.3 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Content Loader -->
    <script src="js/content-loader.js"></script>
    <!-- Custom JS -->
    <script src="js/app.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('💳 Iniciando página da carteira...');

                // 1) Carregar e aplicar conteúdo YAML
                if (window.contentLoader) {
                    await window.contentLoader.loadContent();
                    await window.contentLoader.applyContent();
                    console.log('✅ Conteúdo YAML aplicado');
                }

                // 2) Inicializar ícones Lucide
                if (window.lucide) {
                    window.lucide.createIcons();
                    console.log('✅ Ícones Lucide inicializados');
                }

                // 3) Inicializar tooltips Bootstrap
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
                console.log('✅ Tooltips inicializados');

                // 4) Aguardar que o app.js seja carregado
                await waitForSwiftEliteRewards();

                // 5) Popular transações usando o mecanismo existente
                if (window.SwiftEliteRewards && window.SwiftEliteRewards.getMockTransactions) {
                    const transactions = window.SwiftEliteRewards.getMockTransactions();
                    console.log('💳 Transações carregadas:', transactions);

                    const tbody = document.getElementById('txTableBody');
                    if (tbody && transactions && Array.isArray(transactions)) {
                        tbody.innerHTML = transactions.map(tx => `
                            <tr>
                                <td class="px-4 py-3">${tx.date}</td>
                                <td class="px-4 py-3">${tx.time || '--'}</td>
                                <td class="px-4 py-3">${tx.description}</td>
                                <td class="px-4 py-3">
                                    <span class="fw-semibold ${tx.type === 'credit' ? 'text-success' : 'text-danger'}">
                                        ${tx.type === 'credit' ? '+' : '-'}${Math.abs(tx.amount)}
                                    </span>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="badge ${tx.type === 'credit' ? 'bg-success-subtle text-success' : 'bg-danger-subtle text-danger'}">
                                        ${tx.type === 'credit' ? (window.contentLoader?.getMessage?.('transactions.labels.credit') || 'Crédito') : (window.contentLoader?.getMessage?.('transactions.labels.debit') || 'Débito')}
                                    </span>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="badge bg-secondary-subtle text-secondary">
                                        ${tx.category}
                                    </span>
                                </td>
                            </tr>
                        `).join('');

                        console.log('✅ Transações populadas na tabela');
                    } else {
                        console.warn('⚠️ Não foi possível carregar as transações');
                        if (tbody) {
                            tbody.innerHTML = `
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-muted">
                                        <i class="bi bi-inbox me-2"></i>
                                        Nenhuma transação encontrada
                                    </td>
                                </tr>
                            `;
                        }
                    }
                } else {
                    console.error('❌ SwiftEliteRewards.getMockTransactions não disponível');
                    const tbody = document.getElementById('txTableBody');
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center py-4 text-muted">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    Erro ao carregar transações
                                </td>
                            </tr>
                        `;
                    }
                }

                // 6) Inicializar wallet balance
                if (window.SwiftEliteRewards && window.SwiftEliteRewards.initWalletBalance) {
                    const walletVM = {
                        currency: 'BRL',
                        amount: 1250.00,
                        level: 'Gold',
                        xpPercent: 72,
                        amountToNextLevel: 250.00,
                        lastDelta: 120,
                        redeem: () => {
                            console.log('Resgatar clicado');
                            alert('Funcionalidade de resgate em desenvolvimento');
                        },
                        viewMissions: () => {
                            console.log('Ver missões clicado');
                            alert('Funcionalidade de missões em desenvolvimento');
                        }
                    };

                    window.SwiftEliteRewards.initWalletBalance(walletVM);
                    console.log('✅ Wallet balance inicializado');
                }

                // 7) Popular grid de recompensas
                const rewardsGrid = document.getElementById('rewardsGrid');
                if (rewardsGrid) {
                    const rewards = window.contentLoader?.getContentByPath?.('rewards.items') || [
                        { icon: 'trophy', title: 'Swift Weekend', head: '2 Noites Resort 5★', desc: 'Resort 5 estrelas + Jantar completo com os melhores cortes Swift', coins: '2.500' },
                        { icon: 'briefcase', title: 'Dia do CEO', head: 'Experiência Executiva', desc: 'Passe um dia como CEO da Swift e conheça os bastidores da empresa', coins: '3.000' },
                        { icon: 'utensils', title: 'Faca + Avental', head: 'Kit Profissional', desc: 'Faca premium e avental personalizado com logo Swift', coins: '800' },
                        { icon: 'sparkles', title: 'Concierge Swift', head: 'Experiência VIP', desc: 'Atendimento personalizado, presente surpresa e aventura premium', coins: '5.000' }
                    ];

                    rewardsGrid.innerHTML = rewards.map(reward => `
                        <div class="col-12 col-md-6 col-lg-3">
                            <div class="card border-0 rounded-3 shadow-sm h-100 hover-card">
                                <div class="card-body p-4 d-flex flex-column">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="icon-pill-brand me-3">
                                            <i data-lucide="${reward.icon}" style="width: 20px; height: 20px;"></i>
                                        </div>
                                        <div class="fw-semibold small">${reward.title}</div>
                                    </div>
                                    <div class="h6 text-brand fw-bold mb-2">${reward.head}</div>
                                    <div class="small text-muted mb-3 flex-grow-1">${reward.desc}</div>
                                    <div class="mt-auto">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <span class="text-brand fw-bold">${reward.coins} coins</span>
                                        </div>
                                        <button class="btn btn-outline-brand btn-sm w-100" data-content="rewards.details">
                                            Ver Detalhes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');

                    // Reinicializar ícones Lucide para os novos elementos
                    if (window.lucide) {
                        window.lucide.createIcons();
                    }

                    console.log('✅ Cards de recompensas populados');
                }

                // 8) Toggle já configurado pelo app.js - evitando conflitos

                console.log('🎉 Página da carteira carregada com sucesso!');

            } catch (error) {
                console.error('❌ Erro ao inicializar página da carteira:', error);
                const tbody = document.getElementById('txTableBody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4 text-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Erro ao carregar dados. Verifique o console.
                            </td>
                        </tr>
                    `;
                }
            }
        });

        /**
         * Função para simular expansão da tabela de transações
         */
        function expandTransactions() {
            console.log('📊 Expandindo tabela de transações...');
            
            // Simular carregamento de mais transações
            const tbody = document.getElementById('txTableBody');
            if (tbody) {
                // Adicionar indicador de carregamento
                const loadingRow = document.createElement('tr');
                loadingRow.innerHTML = `
                    <td colspan="6" class="text-center py-3">
                        <div class="d-flex align-items-center justify-content-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            Carregando mais transações...
                        </div>
                    </td>
                `;
                tbody.appendChild(loadingRow);
                
                // Simular carregamento após 1.5 segundos
                setTimeout(() => {
                    // Remover indicador de carregamento
                    tbody.removeChild(loadingRow);
                    
                    // Adicionar transações adicionais simuladas
                    const additionalTransactions = [
                        { id: 'TXN-008', date: '15/01/2024', time: '14:30', description: 'Bônus de performance Q4', amount: 500, type: 'credit', category: 'Bônus' },
                        { id: 'TXN-009', date: '14/01/2024', time: '09:15', description: 'Resgate de benefício', amount: 200, type: 'debit', category: 'Resgate' },
                        { id: 'TXN-010', date: '13/01/2024', time: '16:45', description: 'Pontuação extra por meta', amount: 150, type: 'credit', category: 'Meta' }
                    ];
                    
                    additionalTransactions.forEach(tx => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-4 py-3">${tx.date}</td>
                            <td class="px-4 py-3">${tx.time}</td>
                            <td class="px-4 py-3">${tx.description}</td>
                            <td class="px-4 py-3">
                                <span class="fw-semibold ${tx.type === 'credit' ? 'text-success' : 'text-danger'}">
                                    ${tx.type === 'credit' ? '+' : '-'}${Math.abs(tx.amount)}
                                </span>
                            </td>
                            <td class="px-4 py-3">
                                <span class="badge ${tx.type === 'credit' ? 'bg-success-subtle text-success' : 'bg-danger-subtle text-danger'}">
                                    ${tx.type === 'credit' ? 'Crédito' : 'Débito'}
                                </span>
                            </td>
                            <td class="px-4 py-3">
                                <span class="badge bg-secondary-subtle text-secondary">
                                    ${tx.category}
                                </span>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // Mostrar mensagem de sucesso
                    const successRow = document.createElement('tr');
                    successRow.innerHTML = `
                        <td colspan="6" class="text-center py-2">
                            <small class="text-success">
                                <i class="bi bi-check-circle me-1"></i>
                                Mais transações carregadas com sucesso!
                            </small>
                        </td>
                    `;
                    tbody.appendChild(successRow);
                    
                    // Remover mensagem após 3 segundos
                    setTimeout(() => {
                        if (successRow.parentNode) {
                            successRow.parentNode.removeChild(successRow);
                        }
                    }, 3000);
                    
                    console.log('✅ Transações adicionais carregadas');
                }, 1500);
            }
        }

        /**
         * Aguarda o SwiftEliteRewards ser carregado
         */
        async function waitForSwiftEliteRewards() {
            return new Promise((resolve) => {
                if (window.SwiftEliteRewards) {
                    console.log('✅ SwiftEliteRewards já disponível');
                    resolve();
                    return;
                }

                console.log('⏳ Aguardando SwiftEliteRewards ser carregado...');
                const checkInterval = setInterval(() => {
                    if (window.SwiftEliteRewards) {
                        console.log('✅ SwiftEliteRewards carregado!');
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);

                // Timeout após 5 segundos
                setTimeout(() => {
                    console.warn('⚠️ Timeout aguardando SwiftEliteRewards');
                    clearInterval(checkInterval);
                    resolve();
                }, 5000);
            });
        }
    </script>
</body>
</html>
